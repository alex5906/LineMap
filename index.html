<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Map & Compass</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #000;
            font-family: sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }

        /* --- MAP SECTION --- */
        #map {
            flex-grow: 1; /* Takes up all available space */
            width: 100%;
            z-index: 1;
        }

        /* --- COMPASS SECTION --- */
        #compass-ui {
            height: 80px;
            background-color: #1a1a1a;
            position: relative;
            border-top: 2px solid #444;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* The red center line indicator */
        #indicator {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: red;
            transform: translateX(-50%);
            z-index: 20;
            box-shadow: 0 0 5px red;
        }

        /* The moving tape of numbers/letters */
        #compass-tape {
            position: absolute;
            display: flex;
            will-change: transform;
            /* We create a wide strip. The logic will slide this left/right. */
            width: 7200px; /* Large width to accommodate the repetition */
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .tick {
            width: 40px; /* Space between ticks */
            text-align: center;
            position: relative;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            border-bottom: 1px solid #555;
        }
        
        .tick span {
            margin-bottom: 10px;
        }
        
        /* Specific styling for Cardinals */
        .cardinal {
            color: #00ffcc;
            font-size: 22px;
            text-shadow: 0 0 5px #00ffcc;
        }

        /* --- iOS PERMISSION BUTTON --- */
        #ios-permission-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #007aff;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            z-index: 9999;
            display: none; /* Hidden by default */
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="compass-ui">
        <div id="indicator"></div>
        <div id="compass-tape">
            </div>
    </div>

    <button id="ios-permission-btn">Tap to Enable Compass</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 1. SETUP MAP ---
        // Initialize Leaflet map, center on a placeholder (0,0)
        const map = L.map('map').setView([0, 0], 2);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Create a marker for the user
        const userMarker = L.marker([0, 0]).addTo(map);
        let firstLocation = true;

        // --- 2. GPS LOGIC ---
        function onLocationFound(e) {
            const lat = e.coords.latitude;
            const lng = e.coords.longitude;
            const newLatLng = new L.LatLng(lat, lng);

            userMarker.setLatLng(newLatLng);

            // Zoom to user only on the first find
            if (firstLocation) {
                map.setView(newLatLng, 16);
                firstLocation = false;
            }
        }

        function onLocationError(e) {
            alert("Could not access location. Please ensure GPS is on and HTTPS is used.");
        }

        // Watch position continuously
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onLocationFound, onLocationError, {
                enableHighAccuracy: true,
                maximumAge: 1000
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        // --- 3. COMPASS UI GENERATION ---
        const tape = document.getElementById('compass-tape');
        
        // Generate ticks for 0 to 360 degrees (doubled to 720 for seamless wrapping)
        // We render two full rotations (0-720) so we can loop cleanly without a visual "jump".
        let html = '';
        const step = 5; // One tick every 5 degrees
        
        for (let i = 0; i < 720; i += step) {
            let degree = i % 360;
            let label = '';
            let className = 'tick';

            if (degree === 0) { label = 'N'; className += ' cardinal'; }
            else if (degree === 90) { label = 'E'; className += ' cardinal'; }
            else if (degree === 180) { label = 'S'; className += ' cardinal'; }
            else if (degree === 270) { label = 'W'; className += ' cardinal'; }
            else if (degree % 15 === 0) { label = degree; } // Show numbers every 15 deg
            else { label = '|'; } // Small tick

            html += `<div class="${className}"><span>${label}</span></div>`;
        }
        tape.innerHTML = html;

        // --- 4. COMPASS ORIENTATION LOGIC ---
        
        function handleOrientation(event) {
            let heading = null;

            // iOS Webkit property
            if (event.webkitCompassHeading) {
                heading = event.webkitCompassHeading;
            } 
            // Standard Android property
            else if (event.alpha) {
                // Convert alpha to compass heading (Android's alpha is weirdly distinct from north)
                // This is a basic fallback; Android implementation varies by device.
                heading = 360 - event.alpha; 
            }

            if (heading !== null) {
                updateCompassVisual(heading);
            }
        }

        function updateCompassVisual(heading) {
            // Logic to center the tape based on degrees
            // Each tick is 40px wide and represents 5 degrees.
            // Pixels per degree = 40px / 5deg = 8px/deg.
            const pxPerDeg = 8;
            
            // Offset logic:
            // We want 'heading' to be in the center of the screen.
            // The tape starts at 0.
            // If heading is 0, we want 0 (North) in center.
            // We offset by 360 degrees first to stay in the middle of our "double" strip (safe zone).
            
            // Adjust heading to be within 0-360
            let displayHeading = heading;
            
            // Shift the tape. 
            // We add 360 to the heading to utilize the second half of the strip for smoother wrapping
            // transformation = -(heading + 360) * pixels_per_degree
            // Plus half the screen width to center it.
            
            const centerOffset = window.innerWidth / 2;
            // The tick 0 is at the far left. We need to shift left by (degrees * pxPerDeg).
            // To ensure we don't run out of strip, we use the 360-720 range mostly.
            
            let x = -((displayHeading) * pxPerDeg) + centerOffset - 20; // -20 to center the 40px tick
            
            tape.style.transform = `translateX(${x}px)`;
        }

        // --- 5. PERMISSION HANDLING (iOS 13+) ---
        const btn = document.getElementById('ios-permission-btn');

        // Check if permission is needed (iOS 13+)
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            btn.style.display = 'block'; // Show button
            
            btn.addEventListener('click', () => {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation, true);
                            btn.style.display = 'none';
                        } else {
                            alert('Permission denied');
                        }
                    })
                    .catch(console.error);
            });
        } else {
            // Non-iOS 13+ devices (Android, older iOS) usually don't need permission
            window.addEventListener('deviceorientation', handleOrientation, true);
        }

    </script>
</body>
</html>
