<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Compass Map (Fixed)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Info Box */
        #info {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px; border-radius: 4px;
            font-size: 14px; color: #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        /* Permission Button */
        #start-btn {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 2000;
            padding: 15px 30px; background: #20c997; color: white;
            border: none; border-radius: 50px;
            font-size: 16px; font-weight: bold;
            display: none; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* --- COMPASS UI --- */
        .compass-container {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.9) 30%, #fff 100%);
            z-index: 1000; overflow: hidden; pointer-events: none;
        }

        /* The Center Indicator */
        .compass-indicator {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 0; height: 0;
            border-left: 8px solid transparent; border-right: 8px solid transparent;
            border-bottom: 12px solid #20c997; z-index: 1002;
        }
        
        .compass-center-line {
            position: absolute; bottom: 0; left: 50%; width: 2px; height: 40px;
            background: #20c997; transform: translateX(-50%); z-index: 1002;
        }

        /* The Moving Strip */
        .compass-strip {
            position: absolute; bottom: 0; height: 100%;
            display: flex; align-items: flex-end;
            transition: transform 0.1s linear;
            will-change: transform;
            left: 50%; /* Start at center */
        }

        .tick {
            width: 60px; flex-shrink: 0; text-align: center;
            position: relative; height: 40px;
            color: #555; font-weight: bold; font-size: 14px;
            border-left: 1px solid #ccc;
            box-sizing: border-box; /* Ensures width includes border */
        }
        
        .tick span { position: absolute; top: -20px; left: -50%; width: 200%; text-align: center; }
        
        .tick.major { border-left: 2px solid #333; color: #000; font-size: 16px; height: 50px; }

    </style>
</head>
<body>

<div id="info">Waiting for GPS...</div>
<button id="start-btn">Enable Compass</button>

<div class="compass-container">
    <div class="compass-center-line"></div>
    <div class="compass-indicator"></div>
    <div class="compass-strip" id="compassStrip"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
    // --- 1. SETUP MAP ---
    var map = L.map('map', {zoomControl: false}).setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var userMarker = null;
    var sightLine = null;
    var currentPos = null;
    var currentHeading = 0;
    
    // Config: Tweak this if ticks are too wide/narrow
    const TICK_WIDTH = 60; // pixels
    const DEG_PER_TICK = 10;
    const PIXELS_PER_DEG = TICK_WIDTH / DEG_PER_TICK;

    // --- 2. GENERATE COMPASS STRIP ---
    const compassStrip = document.getElementById('compassStrip');

    function createTicks() {
        let html = '';
        // Create 3 sets (-360 to 720) to allow infinite scrolling
        for (let set = -1; set <= 1; set++) {
            for (let i = 0; i < 360; i += 10) {
                let deg = i;
                let label = deg;
                let isMajor = false;

                if (deg === 0) { label = 'N'; isMajor = true; }
                else if (deg === 90) { label = 'E'; isMajor = true; }
                else if (deg === 180) { label = 'S'; isMajor = true; }
                else if (deg === 270) { label = 'W'; isMajor = true; }

                let className = isMajor ? 'tick major' : 'tick';
                html += `<div class="${className}"><span>${label}</span></div>`;
            }
        }
        compassStrip.innerHTML = html;
    }
    createTicks();

    // --- 3. LOGIC ---
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                currentPos = [lng, lat];
                document.getElementById('info').innerText = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;

                if (!userMarker) {
                    userMarker = L.circleMarker([lat, lng], {
                        color: 'white', weight: 2,
                        fillColor: '#20c997', fillOpacity: 1, radius: 5 
                    }).addTo(map);
                    map.setView([lat, lng], 16);
                } else {
                    userMarker.setLatLng([lat, lng]);
                }
                updateVisuals();
            },
            (err) => console.error(err),
            { enableHighAccuracy: true }
        );
    }

    function handleOrientation(event) {
        let heading = 0;
        
        // 1. Get raw heading
        if (event.webkitCompassHeading) {
            heading = event.webkitCompassHeading; // iOS
        } else if (event.alpha) {
            heading = 360 - event.alpha; // Android
        }

        // 2. Adjust for Screen Orientation (Landscape vs Portrait)
        // If the user turns the phone sideways, the "Top" of the phone changes
        let screenAngle = 0;
        if (window.screen.orientation) {
            screenAngle = window.screen.orientation.angle;
        } else if (window.orientation) {
            screenAngle = window.orientation;
        }
        
        // Subtract screen angle to keep "North" pointing "Up" relative to the screen top
        heading = (heading + screenAngle) % 360;
        if (heading < 0) heading += 360;

        currentHeading = heading;
        updateVisuals();
    }

    function updateVisuals() {
        if (!currentPos) return;

        // A. Update Map Line
        var distance = 50000; 
        var destination = turf.destination(currentPos, distance, currentHeading, { units: 'kilometers' });
        var latlngs = [
            [currentPos[1], currentPos[0]], 
            [destination.geometry.coordinates[1], destination.geometry.coordinates[0]]
        ];

        if (sightLine) {
            sightLine.setLatLngs(latlngs);
        } else {
            sightLine = L.polyline(latlngs, {
                color: '#0e6b56', weight: 2, opacity: 0.8
            }).addTo(map);
        }

        // B. Update Compass Strip
        // Calculation:
        // 1. We start at the MIDDLE 'N' (Set index 1).
        //    One set has 36 ticks (360 / 10).
        //    Width of one set = 36 * 60 = 2160px.
        // 2. We shift LEFT by 2160px to bring the Middle N to the start.
        // 3. We shift LEFT by another 30px (Half tick width) to Center the 'N' on the line.
        // 4. We shift LEFT by currentHeading * pixels_per_degree.
        
        const centerOffset = 2160; // Width of the first set (0-360)
        const halfTick = TICK_WIDTH / 2; // 30px to center the tick text
        const degreeShift = currentHeading * PIXELS_PER_DEG;

        let totalOffset = centerOffset + halfTick + degreeShift;
        
        compassStrip.style.transform = `translateX(-${totalOffset}px)`;
    }

    // Handle Resize/Rotate to recalculate immediately
    window.addEventListener('orientationchange', () => {
        setTimeout(() => {
            // Trigger a dummy event to force re-calc with new screen angle
            // Note: Real deviceorientation events fire constantly anyway
        }, 200);
    });

    const btn = document.getElementById('start-btn');
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        btn.style.display = 'block';
        btn.addEventListener('click', () => {
            DeviceOrientationEvent.requestPermission()
                .then(r => {
                    if (r === 'granted') {
                        window.addEventListener('deviceorientation', handleOrientation, true);
                        btn.style.display = 'none';
                    }
                });
        });
    } else {
        window.addEventListener('deviceorientation', handleOrientation, true);
    }
</script>
</body>
</html>
